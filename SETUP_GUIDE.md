# Руководство по настройке интеграции AMO CRM → Google Sheets

## 1. Настройка вебхука в AMO CRM

### Шаг 1: Получение URL вебхука
После деплоя на Railway ваш URL будет:
```
https://your-app-name.up.railway.app/webhook/amocrm
```

### Шаг 2: Настройка в AMO CRM
1. Войдите в AMO CRM (https://nebar.amocrm.ru)
2. Перейдите в **Настройки** → **Интеграции** → **Вебхуки**
3. Нажмите **"Добавить вебхук"**
4. Заполните поля:
   - **URL**: `https://your-app-name.up.railway.app/webhook/amocrm`
   - **События**: Выберите "Сделка добавлена" и "Сделка изменена"
   - **Метод**: POST
   - **Формат**: JSON

### Шаг 3: Фильтрация по воронке
В настройках вебхука добавьте правило фильтрации:
- **Условие**: Воронка = "ЕВГ СПБ"
- **Действие**: Отправлять данные на вебхук

## 2. Настройка Google Sheets

### Создание таблицы
1. Откройте Google Sheets
2. Создайте новую таблицу или используйте существующую: 
   `https://docs.google.com/spreadsheets/d/1tD89CZMI8KqaHBx0gmGsHpc9eKYvpuk3OnCOpDYMDdE`

### Структура таблицы
Таблица должна содержать следующие колонки (A-M):

| Колонка | Поле | Описание |
|---------|------|----------|
| A | ID сделки | Уникальный идентификатор |
| B | Название сделки | Имя сделки |
| C | Бюджет | Сумма сделки в рублях |
| D | Дата создания | ISO формат |
| E | Дата изменения | ISO формат |
| F | Этап | Название этапа воронки |
| G | Ответственный | Имя ответственного |
| H | Контакт | Имя контакта |
| I | Телефон | Номер телефона |
| J | Email | Электронная почта |
| K | Компания | Название компании |
| L | Статус | Активна/Удалена |
| M | Источник | AMO CRM |

### Права доступа
1. Откройте настройки доступа к таблице
2. Добавьте сервисный аккаунт: `evgenich-logger@gen-lang-client-0841321145.iam.gserviceaccount.com`
3. Предоставьте права "Редактор"

## 3. Настройка в Railway

Все переменные окружения уже настроены:

```env
AMO_ACCESS_TOKEN=your_token
AMO_CLIENT_ID=afa9bc07-3906-46a8-b92d-32c9094038b8
AMO_CLIENT_SECRET=your_secret
AMO_DOMAIN=nebar.amocrm.ru
AMO_REDIRECT_URI=https://spb.evgenich.bar
AMO_REFRESH_TOKEN=your_refresh_token
AMO_TOKEN=your_token
DEBUG_SKIP_FILTER=false
GOOGLE_CREDENTIALS=your_service_account_json
GOOGLE_SHEET_GID=0
GOOGLE_SHEET_ID=1tD89CZMI8KqaHBx0gmGsHpc9eKYvpuk3OnCOpDYMDdE
PORT=3000
PROJECT_ID=be74ec23-6958-4803-bb5b-66a31c02b422
RAILWAY_TOKEN=your_railway_token
```

## 4. Тестирование интеграции

### Проверка состояния системы
```bash
GET https://your-app-name.up.railway.app/health
GET https://your-app-name.up.railway.app/status
```

### Тестирование подключений
```bash
GET https://your-app-name.up.railway.app/test/amocrm
GET https://your-app-name.up.railway.app/test/google-sheets
```

### Ручная синхронизация сделки
```bash
POST https://your-app-name.up.railway.app/sync/deal/123456
```

### Проверка вебхука
```bash
GET https://your-app-name.up.railway.app/webhook/health
```

## 5. Мониторинг и логирование

### Просмотр логов в Railway
1. Откройте проект в Railway
2. Перейдите в раздел "Deployments"
3. Выберите активный деплой
4. Откройте "View Logs"

### Анализ событий
Все события записываются с метками:
- `WEBHOOK_RECEIVED` - получен вебхук
- `WEBHOOK_PROCESSED` - обработан вебхук
- `AMO_API_CALL` - вызов AMO CRM API
- `GOOGLE_SHEETS_OPERATION` - операция с Google Sheets
- `TOKEN_REFRESH` - обновление токена

### Проверка синхронизации
1. Создайте тестовую сделку в воронке "ЕВГ СПБ"
2. Проверьте логи приложения
3. Убедитесь, что сделка появилась в Google Таблице

## 6. Обработка ошибок

### Частые проблемы и решения

#### Ошибка 401 (Unauthorized)
- Проверьте токены AMO CRM
- Токен автоматически обновляется каждый час

#### Ошибка 403 (Forbidden) для Google Sheets
- Проверьте права доступа к таблице
- Убедитесь, что сервисный аккаунт добавлен как редактор

#### Сделки не синхронизируются
- Проверьте фильтр воронки "ЕВГ СПБ"
- Установите `DEBUG_SKIP_FILTER=true` для отладки

#### Rate Limit ошибки
- Система автоматически повторяет запросы
- Настроены лимиты: 100 запросов/мин для вебхука

## 7. Масштабирование

### Увеличение лимитов
Если нужно обрабатывать больше запросов:
1. Увеличьте лимиты в `src/middleware/rateLimiter.js`
2. Добавьте Redis для распределенного rate limiting

### Дополнительные воронки
Для добавления других воронок:
1. Измените фильтр в `amoService.isDealFromEvgSpbPipeline()`
2. Или создайте отдельные вебхуки для разных воронок

### Резервное копирование
1. Настройте регулярные бэкапы Google Sheets
2. Дублируйте данные в дополнительные листы

## 8. Безопасность

### Рекомендации
- Регулярно обновляйте токены
- Мониторьте подозрительную активность
- Используйте HTTPS для всех соединений
- Ограничьте доступ к таблице только необходимым пользователям

### Аудит
Все операции записываются в лист "Audit" (если создан) с информацией:
- Время операции
- Тип действия
- ID сделки
- Результат операции

## Контакты поддержки

При возникновении проблем:
1. Проверьте логи Railway
2. Используйте эндпоинт `/status` для диагностики
3. Обратитесь к разработчику с логами ошибок
